<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Game Library Dashboard</title>
    <link rel="icon" href="{{ url_for('static', filename='images/logo.png') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="header">
        <h1><i class="fab fa-steam"></i> My Game Library Dashboard</h1>
        <div class="sort-controls">
            <label for="sort-by">Sort by:</label>
            <select id="sort-by">
                <option value="name">&#xf15c; Name</option>
                <option value="rating">&#xf005; Rating</option>
                <option value="reviews">&#xf086; Number of Reviews</option>
                <option value="release_date">&#xf133; Release Date</option>
                <option value="size">&#xf1c0; Size</option>
            </select>
            <select id="sort-direction">
                <option value="asc">Ascending</option>
                <option value="desc">Descending</option>
            </select>
            <input type="text" id="search-box" placeholder="Search by name or description...">
        </div>
        <div class="genre-filter">
            {% for genre in all_genres %}
            <label>
                <input type="checkbox" class="genre-checkbox" value="{{ genre }}"> {{ genre }}
            </label>
            {% endfor %}
        </div>
    </div>
    <div class="game-grid">
        {% for game in games %}
        <div class="game-card" data-name="{{ game.name }}" data-rating="{{ game.review_desc }}" data-reviews="{{ game.total_reviews }}" data-release-date="{{ game.release_date }}" data-size="{{ game.storage }}" data-description="{{ game.short_description }}" data-genres="{{ game.genres | join(',') }}">
            <a href="{{ game.steam_url }}" target="_blank">
                <img src="{{ game.cover_url }}" alt="{{ game.name }} Cover">
                <div class="game-info">
                    <p class="game-name">{{ game.name }}</p>
                    <p class="game-description">{{ game.short_description }}</p>
                    <div class="game-details">
                        <p class="game-release-date"><strong>Released:</strong> {{ game.release_date }}</p>
                        <p class="game-storage"><strong>Size:</strong> {{ game.storage }}</p>
                        <div class="game-genres">
                            {% for genre in game.genres %}
                                <span class="genre-tag">{{ genre }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    <p class="game-review {{ game.review_desc | lower | replace(' ', '-') }}">
                        {{ game.review_desc }}
                        {% if game.total_reviews > 0 %}
                            ({{ "{:,}".format(game.total_reviews) }})
                        {% endif %}
                    </p>
                </div>
            </a>
            <div class="card-buttons">
                {% if game.video_url %}
                <button class="video-button" data-video-url="{{ game.video_url }}">Video</button>
                {% endif %}
                {% if game.screenshots %}
                <button class="screenshots-button" data-screenshots="{{ game.screenshots | join(',') }}">Screenshots ({{ game.screenshots | length }})</button>
                {% endif %}
                {% if not cache_only and game.installer_path %}
                <button class="install-button" data-game-name="{{ game.name }}">Install</button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Screenshot Modal -->
    <div id="screenshot-modal" class="modal">
        <span class="close-button">&times;</span>
        <img class="modal-content" id="modal-image">
        <a class="prev">&#10094;</a>
        <a class="next">&#10095;</a>
    </div>

    <!-- Video Modal -->
    <div id="video-modal" class="modal">
        <span class="video-close-button">&times;</span>
        <video class="modal-content" id="modal-video" controls autoplay></video>
    </div>

    <script>
        const sortControls = document.querySelectorAll('#sort-by, #sort-direction');
        sortControls.forEach(control => control.addEventListener('change', filterAndSortGames));
        document.getElementById('search-box').addEventListener('input', filterAndSortGames);
        document.querySelectorAll('.genre-checkbox').forEach(checkbox => checkbox.addEventListener('change', filterAndSortGames));

        function filterAndSortGames() {
            const searchText = document.getElementById('search-box').value.toLowerCase();
            const selectedGenres = Array.from(document.querySelectorAll('.genre-checkbox:checked')).map(cb => cb.value);
            const gameCards = document.querySelectorAll('.game-card');

            gameCards.forEach(card => {
                const name = card.dataset.name.toLowerCase();
                const description = card.dataset.description.toLowerCase();
                const cardGenres = card.dataset.genres.split(',');

                const searchMatch = name.includes(searchText) || description.includes(searchText);
                const genreMatch = selectedGenres.length === 0 || selectedGenres.some(genre => cardGenres.includes(genre));

                card.style.display = searchMatch && genreMatch ? '' : 'none';
            });

            sortGames();
        }

        function sortGames() {
            const sortBy = document.getElementById('sort-by').value;
            const sortDirection = document.getElementById('sort-direction').value;
            const gameGrid = document.querySelector('.game-grid');
            const gameCards = Array.from(gameGrid.querySelectorAll('.game-card'));

            const ratingOrder = [
                'Overwhelmingly Positive', 'Very Positive', 'Positive', 'Mostly Positive', 'Mixed',
                'Mostly Negative', 'Negative', 'Very Negative', 'Overwhelmingly Negative'
            ];

            gameCards.sort((a, b) => {
                let result = 0;
                const aName = a.dataset.name;
                const bName = b.dataset.name;
                let aRatingIndex = ratingOrder.indexOf(a.dataset.rating);
                let bRatingIndex = ratingOrder.indexOf(b.dataset.rating);
                if (aRatingIndex === -1) aRatingIndex = Infinity;
                if (bRatingIndex === -1) bRatingIndex = Infinity;
                const aReviews = parseInt(a.dataset.reviews, 10);
                const bReviews = parseInt(b.dataset.reviews, 10);
                const aDate = new Date(a.dataset.releaseDate);
                const bDate = new Date(b.dataset.releaseDate);
                let aSize = parseFloat(a.dataset.size.replace(' GB', ''));
                let bSize = parseFloat(b.dataset.size.replace(' GB', ''));
                if (isNaN(aSize)) aSize = Infinity;
                if (isNaN(bSize)) bSize = Infinity;

                if (sortBy === 'name') {
                    result = aName.localeCompare(bName);
                } else if (sortBy === 'rating') {
                    result = aRatingIndex - bRatingIndex;
                } else if (sortBy === 'reviews') {
                    result = aReviews - bReviews;
                } else if (sortBy === 'release_date') {
                    result = aDate - bDate;
                } else if (sortBy === 'size') {
                    result = aSize - bSize;
                }

                return sortDirection === 'asc' ? result : -result;
            });

            gameCards.forEach(card => gameGrid.appendChild(card));
        }

        document.querySelectorAll('.install-button').forEach(button => {
            button.addEventListener('click', function(event) {
                event.stopPropagation(); // Prevent card link click
                const gameName = this.dataset.gameName;
                fetch(`/install/${gameName}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log(data.message);
                        this.textContent = 'Launched!';
                        setTimeout(() => { this.textContent = 'Install'; }, 2000);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        this.textContent = 'Error!';
                        setTimeout(() => { this.textContent = 'Install'; }, 2000);
                    });
            });
        });

        // Screenshot Modal Logic
        const modal = document.getElementById('screenshot-modal');
        const modalImg = document.getElementById('modal-image');
        const closeBtn = document.querySelector('.close-button');
        const prevBtn = document.querySelector('.prev');
        const nextBtn = document.querySelector('.next');
        let currentScreenshots = [];
        let currentIndex = 0;

        function preloadImages(urls) {
            urls.forEach(url => {
                new Image().src = url;
            });
        }

        document.querySelectorAll('.screenshots-button').forEach(button => {
            button.addEventListener('click', function(event) {
                event.stopPropagation(); // Prevent card link click
                currentScreenshots = this.dataset.screenshots.split(',');
                currentIndex = 0;
                updateModalImage();
                modal.style.display = 'block';
                // Preload the other images
                preloadImages(currentScreenshots.slice(1));
            });
        });

        function updateModalImage() {
            modalImg.src = currentScreenshots[currentIndex];
        }

        function showPrevImage() {
            currentIndex = (currentIndex > 0) ? currentIndex - 1 : currentScreenshots.length - 1;
            updateModalImage();
        }

        function showNextImage() {
            currentIndex = (currentIndex < currentScreenshots.length - 1) ? currentIndex + 1 : 0;
            updateModalImage();
        }

        closeBtn.onclick = () => modal.style.display = 'none';
        prevBtn.onclick = showPrevImage;
        nextBtn.onclick = showNextImage;
        
        window.onclick = (event) => {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };

        // Keyboard navigation for screenshots
        document.addEventListener('keydown', function(event) {
            if (modal.style.display === 'block') {
                if (event.key === 'ArrowLeft') {
                    showPrevImage();
                } else if (event.key === 'ArrowRight') {
                    showNextImage();
                } else if (event.key === 'Escape') {
                    modal.style.display = 'none';
                }
            }
            if (videoModal.style.display === 'block' && event.key === 'Escape') {
                closeVideoModal();
            }
        });

        // Video Modal Logic
        const videoModal = document.getElementById('video-modal');
        const videoPlayer = document.getElementById('modal-video');
        const videoCloseBtn = document.querySelector('.video-close-button');

        document.querySelectorAll('.video-button').forEach(button => {
            button.addEventListener('click', function(event) {
                event.stopPropagation(); // Prevent card link click
                const videoUrl = this.dataset.videoUrl;
                videoPlayer.src = videoUrl;
                videoModal.style.display = 'block';
            });
        });

        function closeVideoModal() {
            videoModal.style.display = 'none';
            videoPlayer.pause();
            videoPlayer.src = '';
        }

        videoCloseBtn.onclick = closeVideoModal;
        window.addEventListener('click', (event) => {
            if (event.target == videoModal) {
                closeVideoModal();
            }
        });
    </script>
</body>
</html>
